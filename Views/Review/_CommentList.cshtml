@using ProjectTest1.ViewModels
@model IEnumerable<ReviewViewModel>

<div class="container mt-4">
    <h4>Quản lý bình luận</h4>
    <hr />

    @if (Model == null || !Model.Any())
    {
        <div class="text-center text-muted py-5">
            <i class="fa fa-comments fa-3x mb-3 opacity-50"></i>
            <h5 class="mb-0">Chưa có bình luận nào.</h5>
        </div>
    }
    else
    {
        foreach (var r in Model)
        {
            <div class="card mb-3 shadow-sm rounded-3 position-relative @(r.IsVisible ? "" : "opacity-50 border-danger")">
                @* Nhãn “Đã ẩn” ở góc trên *@
                @if (!r.IsVisible)
                {
                    <div class="position-absolute top-0 start-0 bg-danger text-white px-3 py-1 rounded-end" style="font-size: 0.85rem;">
                        <i class="fa fa-eye-slash me-1"></i> Đã ẩn
                    </div>
                }

                <div class="row g-0 align-items-start">
                    <!-- Ảnh sản phẩm -->
                    <div class="col-auto p-3">
                        <img src="@(!string.IsNullOrEmpty(r.ProductImage) ? r.ProductImage : "/images/no-image.png")"
                             alt="@r.ProductName"
                             class="rounded border"
                             style="width:100px; height:100px; object-fit:cover;" />
                    </div>

                    <!-- Nội dung bình luận -->
                    <div class="col">
                        <div class="card-body p-3">
                            <!-- Header -->
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center">
                                    @* <img src="https://i.pravatar.cc/40" *@
                                    <img src="@r.avatarUrl"
                                         alt="@r.ReviewerName"
                                         class="rounded-circle me-2 border"
                                         style="width:40px; height:40px; object-fit:cover;" />
                                    <div>
                                        <strong>
                                            @(r.ReviewerName ?? "(Người dùng đã xoá)")
                                            @if (!r.IsVisible)
                                            {
                                                <span class="badge bg-danger ms-1">Đang ẩn</span>
                                            }
                                </strong>
                                <small class="text-muted d-block">@r.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                            </div>
                        </div>

                        <!-- Hành động -->
                        <div class="text-end">
                            <button class="btn btn-sm @(r.IsVisible ? "btn-outline-secondary" : "btn-outline-warning") hide-btn mb-1"
                                    onclick="reviewAdmin.changeVisible(@r.Id)"
                                    data-id="@r.Id"
                                    title="@(r.IsVisible ? "Ẩn bình luận" : "Hiển thị lại")">
                                <i class="fa @(r.IsVisible ? "fa-eye-slash" : "fa-eye")"></i>
                            </button>
                            @if (!string.IsNullOrEmpty(r.SellerReply))
                            {
                            <button class="btn btn-sm btn-outline-primary edit-reply-btn"
                                   data-id="@r.Id"
                                   data-reply="@r.SellerReply"
                                   title="Sửa phản hồi">
                                   <i class="fa fa-edit"></i>
                                        </button>
                            }

                        </div>
                    </div>

                    <!-- Nội dung bình luận -->
                    <div class="mb-2">
                        <p class="mb-2 border-start border-3 border-info ps-3 py-2 bg-light rounded" style="font-weight: 500;">
                            @(
                                                        r.Comment?.Length > 150
                                                        ? r.Comment.Substring(0, 150) + "..."
                                                        : r.Comment
                                                        )
                        </p>
                        <small class="text-muted">Sản phẩm: <em>@r.ProductName</em></small>
                    </div>

                            <!-- Reply admin -->
                    @if (!string.IsNullOrEmpty(r.SellerReply))
                            {
                                <div class="bg-light rounded-3 p-2 mt-3 border-start border-4 border-warning">
                                    <strong>Admin:</strong> @r.SellerReply
                                    <br />
                                    <small class="text-muted">@r.SellerReplyAt?.ToString("dd/MM/yyyy HH:mm")</small>
                                </div>
                                <form id="updateForm-@r.Id"
                                      class="updateForm mt-3"
                                      data-comment-id="@r.Id"
                                      style="display:none;">
                                    <div class="d-flex">
                                        <input type="text"
                                               id="textReply-@r.Id"
                                               name="reply"
                                               class="form-control me-2 flex-grow-1"
                                               placeholder="Trả lời bình luận..." 
                                        style="width:860px">

                                        <button type="submit" class="btn btn-primary me-2">
                                            <i class="fa fa-paper-plane"></i>
                                        </button>

                                        <!-- Nút Hủy -->
                                        <button type="button" class="btn btn-outline-secondary cancel-reply-btn" data-form-id="updateForm-@r.Id" onclick="reviewAdmin.cancelUpdate(this)">
                                            <i class="fa fa-times"></i>
                                        </button>
                                    </div>

                                </form>

                            }
                            else
                            {
                                <form id="replyForm" class="replyForm mt-3 d-flex" data-comment-id="@r.Id">
                                    <input type="text" id="textReply" name="reply" class="form-control me-2" placeholder="Trả lời bình luận..." />
                                    <button type="submit" class="btn btn-primary" >
                                        <i class="fa fa-paper-plane"></i>
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                Tổng số bình luận: <strong>@ViewBag.Total</strong>
            </div>
            <div id="pagination" data-total-pages="@ViewBag.TotalPage">
                <ul id="paging-ul" class="pagination pagination-sm mb-0"></ul>
            </div>
        </div>
    }
</div>
